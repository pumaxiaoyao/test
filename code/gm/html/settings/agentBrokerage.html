<div class="modal fade bs-modal-lg" id="apportionModal" tabindex="-1" role="basic" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <button class="close" type="button" data-dismiss="modal">×</button>
                <h3>抽佣结算分摊
                    <span updated=updated></span>
                </h3>
            </div>
            <div class="modal-body">
                <div class="row">
                    <table class="table table-striped table-bordered table-hover table-full-width">
                        <thead>
                            <tr>
                                <th width="20%;">分摊相关项</th>
                                <th width="20%;">分摊方式</th>
                                <th width="20%;">比例（%）</th>
                                <th width="40%;">说明</th>
                            </tr>
                        </thead>
                        <tbody>
                            <form id="apportionForm">
                                <tr>
                                    <td>存款优惠承担比例(%)</td>
                                    <td>
                                        <select class="form-control" id="depositChoose">
                                            <option value="0">不分摊</option>
                                            <option value="1">固定比例分摊</option>
                                            <option value="2">同浮动抽佣比例</option>
                                        </select>
                                    </td>
                                    <td>
                                        <input type="text" id="depositratedata" name="depositratedata" size="8" placeholder="">
                                    </td>
                                    <td>代理线下玩家存款时，公司给予的手续费优惠红利，分摊方式选择“不分摊”则代理不承担，建议固定分摊比例100%或同浮动抽佣比例</td>
                                </tr>
                                <tr>
                                    <td>返水承担比例(%)</td>
                                    <td>
                                        <select class="form-control" id="rebateChoose">
                                            <option value="0">不分摊</option>
                                            <option value="1">固定比例分摊</option>
                                            <option value="2">同浮动抽佣比例</option>
                                        </select>
                                    </td>
                                    <td>
                                        <input type="text" id="rebateratedata" name="rebateratedata" size="8" placeholder="">
                                    </td>
                                    <td>给予代理线下玩家返水，由代理商承担的比例，分摊方式选择“不分摊”则代理不承担，建议固定分摊比例100%或同浮动抽佣比例</td>
                                </tr>
                                <tr>
                                    <td>红利承担比例(%)</td>
                                    <td>
                                        <select class="form-control" id="bonusChoose">
                                            <option value="0">不分摊</option>
                                            <option value="1">固定比例分摊</option>
                                            <option value="2">同浮动抽佣比例</option>
                                        </select>
                                    </td>
                                    <td>
                                        <input type="text" id="bonusratedata" name="bonusratedata" size="8" placeholder="">
                                    </td>
                                    <td>线下玩家获取红利时，代理商承担的比例，分摊方式选择“不分摊”则代理不承担，建议 固定分摊比例100%或同浮动抽佣比例</td>
                                </tr>
                                <tr>
                                    <td>线路费比例(%)</td>
                                    <td>
                                        <select class="form-control" id="linefeeChoose">
                                            <option value="0">不承担</option>
                                            <option value="1">固定比例</option>
                                            <option value="2">浮动比例</option>
                                        </select>
                                    </td>
                                    <td>
                                        <input type="text" id="linefeeratedata" name="linefeeratedata" size="8" placeholder="">
                                        <a href="#floatSettingModal" id="linefeeconfig" modalTag="linefee" data-toggle="modal" class="btn btn-xs blue">浮动比例设置</a>
                                    </td>
                                    <td>线路费可以以固定的比例和浮动比例同时存在。线路费的浮动比例是使用结算输赢进行比例计算的单独比例配置</td>
                                </tr>
                                <tr>
                                    <td>有效会员</td>
                                    <td>
                                        <input onkeyup="clearNoNum(this)" type="text" id="validBate" size="4" placeholder="">有效会员投注额
                                    </td>
                                    <td>
                                        <input onkeyup="clearNoNum(this)" type="text" id="validMember" size="4" placeholder="">有效会员数
                                    </td>
                                    <td>要求代理线下玩家当月投注额超过“有效会员投注额”的会员数量。</td>
                                </tr>
                            </form>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary red" onclick="saveApportion(this);">保存</button>
                <button class="btn" data-dismiss="modal" aria-hidden="true">取消</button>
            </div>

        </div>
    </div>
    <script>
        /**
         * 录入完成后，输入模式失去焦点后对录入进行判断并强制更改，并对小数点进行0补全
         **/
        function overFormat(th) {
            var v = th.value;
            if (v === '') {
                // v = '0.00';
            } else if (v === '0') {
                v = '0.00';
            } else if (v === '0.') {
                v = '0.00';
            } else if (/^0+\d+\.?\d*.*$/.test(v)) {
                v = v.replace(/^0+(\d+\.?\d*).*$/, '$1');
                // v = inp.getRightPriceFormat(v).val;
            } else if (/^0\.\d$/.test(v)) {
                v = v + '0';
            } else if (!/^\d+\.\d{2}$/.test(v)) {
                if (/^\d+\.\d{2}.+/.test(v)) {
                    v = v.replace(/^(\d+\.\d{2}).*$/, '$1');
                } else if (/^\d+$/.test(v)) {
                    v = v + '.00';
                } else if (/^\d+\.$/.test(v)) {
                    v = v + '00';
                } else if (/^\d+\.\d$/.test(v)) {
                    v = v + '0';
                } else if (/^[^\d]+\d+\.?\d*$/.test(v)) {
                    v = v.replace(/^[^\d]+(\d+\.?\d*)$/, '$1');
                } else if (/\d+/.test(v)) {
                    v = v.replace(/^[^\d]*(\d+\.?\d*).*$/, '$1');
                    ty = false;
                } else if (/^0+\d+\.?\d*$/.test(v)) {
                    v = v.replace(/^0+(\d+\.?\d*)$/, '$1');
                    ty = false;
                } else {
                    v = '0.00';
                }
            }
            if (v < 0) {
                v = "0.00";
            } else if (v > 100) {
                v = "100.00";
            }
            th.value = v;
        }

        function setLineFloat() {
            $("#brokerageModalTitle").attr("modalTag", "linefee");
            var layerid = $("#apportionForm").attr("layerid");
            var lineFloatStr = $("#agentLayerCommon" + layerid).attr("linefloatStr");
            setFloatData(lineFloatStr);
        }

        function setFloatData(floatStr) {
            console.log(floatStr);
            var mtag = $("#brokerageModalTitle").attr("modalTag");
            if (mtag == "linefee") {
                $("#FloatSettingTitle").html(
                    "线路阶梯比例设置<br/><font color=red>【请注意：此阶梯比例根据代理总输赢数值计算阶梯，而不是单平台的输赢】</font>"
                );
                $("#FloatSettingTitle").attr("settingtag", "linefee");
            } else if (mtag == "commision") {
                $("#FloatSettingTitle").html(
                    "抽佣阶梯比例设置<br/><font color=red>【请注意：此阶梯比例根据代理总输赢数值计算阶梯，而不是单平台的输赢】</font>"
                );
                $("#FloatSettingTitle").attr("settingtag", "commision");
            } else if (mtag == "water") {
                var game = $("#FloatSettingTitle").attr("gameTag");
                $("#FloatSettingTitle").html(
                    game + "抽水阶梯比例设置<br/><font color=red>【请注意：此阶梯比例根据代理总输赢数值计算阶梯，而不是单平台的输赢】</font>"
                );
                $("#FloatSettingTitle").attr("settingtag", "water");
            }
            $("#t_waterlever").find("tbody").html("");
            if (typeof (floatStr) != "undefined" && floatStr.length > 0 && isContains(floatStr, "_")) {
                var nsfloat = floatStr.split("|");
                for (var i = 0; i < nsfloat.length; i++) {
                    var nd = nsfloat[i].split("_");
                    addlevertr(nd[0], (nd[1] * 100).toFixed(2));
                }
            }

        }

        function isContains(str, substr) {
            return str.indexOf(substr) >= 0;
        }

        function showRate(floatStr) {
            var newfloatStr = "暂无数据";
            if (typeof (floatStr) != "undefined" && floatStr.length > 0 && isContains(floatStr, "_")) {
                var nsfloat = floatStr.split("|");
                var perc = [];
                for (var i = 0; i < nsfloat.length; i++) {
                    var nd = nsfloat[i].split("_");
                    perc.push((nd[1] * 100).toFixed(2));
                }
                var maxV = Math.max.apply(null, perc);
                var minV = Math.min.apply(null, perc);
                newfloatStr = minV + "% ~ " + maxV + "%";
            }
            return newfloatStr;
        }

        function updateSelect(opt, val, elName) {
            var layerid = $("#apportionForm").attr("layerid");
            var dataObj = $("#" + elName + "ratedata");
            var selectObj = $("#" + elName + "Choose");
            selectObj.val(opt);
            var floatRate = $("#agentLayerCommon" + layerid).attr("floatStr");
            var linefloatRate = $("#agentLayerCommon" + layerid).attr("linefloatStr");
            if (opt == 0) {
                dataObj.hide();
                dataObj.attr("onblur", "");
                if (elName == "linefee") {
                    $("#linefeeconfig").hide();
                }
            } else if (opt == 1) {
                dataObj.show();
                dataObj.attr("readonly", false);
                dataObj.css('background', '#ffffff');
                dataObj.attr("onblur", "overFormat(this)");

                dataObj.val(val * 100);
                if (elName == "linefee") {
                    $("#linefeeconfig").hide();
                }
            } else if (opt == 2) {
                dataObj.show();
                dataObj.attr("readonly", true);
                dataObj.css('background', "#C0C0C0");
                dataObj.attr("onblur", "");
                if (elName == "linefee") {
                    $("#linefeeconfig").show();
                    dataObj.val(showRate(linefloatRate));
                } else {
                    dataObj.val(showRate(floatRate));
                }
            }
        }

        $(document).ready(function () {
            $("#depositChoose").change(function () {
                var selectVal = $(this).children('option:selected').val();
                updateSelect(selectVal, "", "deposit");
            });
            $("#bonusChoose").change(function () {
                var selectVal = $(this).children('option:selected').val();
                updateSelect(selectVal, "", "bonus");
            });
            $("#rebateChoose").change(function () {
                var selectVal = $(this).children('option:selected').val();
                updateSelect(selectVal, "", "rebate");
            });
            $("#linefeeChoose").change(function () {
                var selectVal = $(this).children('option:selected').val();
                updateSelect(selectVal, "", "linefee");
            });

            $("#apportionModal").delegate("a", "click", function (o) {
                var modalTag = $(this).attr("modalTag");
                if (modalTag == "linefee") {
                    $("#brokerageModalTitle").attr("modalTag", "linefee");
                    var layerid = $("#apportionForm").attr("layerid");
                    var lineFloatStr = $("#agentLayerCommon" + layerid).attr("linefloatStr");
                    setFloatData(lineFloatStr);
                }
            });


        });
    </script>